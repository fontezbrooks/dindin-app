name: CI Pipeline

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  BUN_VERSION: "1.2.0"
  NODE_VERSION: "20"

jobs:
  changes:
    name: Detect Changes
    runs-on: ubuntu-latest
    outputs:
      backend: ${{ steps.changes.outputs.backend }}
      frontend: ${{ steps.changes.outputs.frontend }}
      packages: ${{ steps.changes.outputs.packages }}
      workflows: ${{ steps.changes.outputs.workflows }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Detect changes
        uses: dorny/paths-filter@v3
        id: changes
        with:
          filters: |
            backend:
              - 'apps/backend/**'
              - 'packages/**'
              - 'package.json'
              - 'bun.lock'
              - 'turbo.json'
              - 'tsconfig*.json'
              - 'biome.jsonc'
            frontend:
              - 'apps/frontend/**'
              - 'packages/**'
              - 'package.json'
              - 'bun.lock'
              - 'turbo.json'
              - 'tsconfig*.json'
              - 'biome.jsonc'
            packages:
              - 'packages/**'
              - 'package.json'
              - 'bun.lock'
              - 'turbo.json'
              - 'tsconfig*.json'
              - 'biome.jsonc'
            workflows:
              - '.github/workflows/**'

  setup:
    name: Setup Dependencies
    runs-on: ubuntu-latest
    needs: changes
    if: needs.changes.outputs.backend == 'true' || needs.changes.outputs.frontend == 'true' || needs.changes.outputs.packages == 'true'

    outputs:
      cache-key: ${{ steps.cache-key.outputs.key }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: ${{ env.BUN_VERSION }}

      - name: Generate cache key
        id: cache-key
        run: |
          echo "key=bun-${{ hashFiles('bun.lock', 'package.json', 'apps/*/package.json', 'packages/*/package.json') }}" >> $GITHUB_OUTPUT

      - name: Cache node modules
        uses: actions/cache@v4
        id: cache-deps
        with:
          path: |
            node_modules
            apps/*/node_modules
            packages/*/node_modules
            ~/.bun/install/cache
          key: ${{ steps.cache-key.outputs.key }}
          restore-keys: |
            bun-${{ hashFiles('bun.lock') }}
            bun-

      - name: Install dependencies
        if: steps.cache-deps.outputs.cache-hit != 'true'
        run: bun install --frozen-lockfile

      - name: Cache Turbo
        uses: actions/cache@v4
        with:
          path: .turbo
          key: turbo-${{ github.sha }}
          restore-keys: |
            turbo-

  lint:
    name: Lint & Format
    runs-on: ubuntu-latest
    needs: [changes, setup]
    if: needs.changes.outputs.backend == 'true' || needs.changes.outputs.frontend == 'true' || needs.changes.outputs.packages == 'true'

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: ${{ env.BUN_VERSION }}

      - name: Restore dependencies cache
        uses: actions/cache@v4
        with:
          path: |
            node_modules
            apps/*/node_modules
            packages/*/node_modules
            ~/.bun/install/cache
          key: ${{ needs.setup.outputs.cache-key }}
          fail-on-cache-miss: true

      - name: Restore Turbo cache
        uses: actions/cache@v4
        with:
          path: .turbo
          key: turbo-${{ github.sha }}
          restore-keys: |
            turbo-

      - name: Run Biome check
        run: bun run check

      - name: Run Turbo lint
        run: bun run turbo lint

  typecheck:
    name: Type Check
    runs-on: ubuntu-latest
    needs: [changes, setup]
    if: needs.changes.outputs.backend == 'true' || needs.changes.outputs.frontend == 'true' || needs.changes.outputs.packages == 'true'

    strategy:
      matrix:
        workspace: [backend, frontend]
        include:
          - workspace: backend
            condition: needs.changes.outputs.backend == 'true'
          - workspace: frontend
            condition: needs.changes.outputs.frontend == 'true'
      fail-fast: false

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: ${{ env.BUN_VERSION }}

      - name: Restore dependencies cache
        uses: actions/cache@v4
        with:
          path: |
            node_modules
            apps/*/node_modules
            packages/*/node_modules
            ~/.bun/install/cache
          key: ${{ needs.setup.outputs.cache-key }}
          fail-on-cache-miss: true

      - name: Restore Turbo cache
        uses: actions/cache@v4
        with:
          path: .turbo
          key: turbo-${{ github.sha }}
          restore-keys: |
            turbo-

      - name: Run type check for ${{ matrix.workspace }}
        if: matrix.condition == 'true'
        run: bun run turbo check-types --filter=${{ matrix.workspace }}

  test-backend:
    name: Test Backend
    runs-on: ubuntu-latest
    needs: [changes, setup]
    if: needs.changes.outputs.backend == 'true'

    services:
      mongodb:
        image: mongo:7
        ports:
          - 27017:27017
        env:
          MONGO_INITDB_ROOT_USERNAME: test
          MONGO_INITDB_ROOT_PASSWORD: test
        options: >-
          --health-cmd "mongosh --eval 'db.adminCommand(\"ping\")'"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

      redis:
        image: redis:7-alpine
        ports:
          - 6379:6379
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: ${{ env.BUN_VERSION }}

      - name: Restore dependencies cache
        uses: actions/cache@v4
        with:
          path: |
            node_modules
            apps/*/node_modules
            packages/*/node_modules
            ~/.bun/install/cache
          key: ${{ needs.setup.outputs.cache-key }}
          fail-on-cache-miss: true

      - name: Restore Turbo cache
        uses: actions/cache@v4
        with:
          path: .turbo
          key: turbo-${{ github.sha }}
          restore-keys: |
            turbo-

      - name: Run backend tests
        run: bun run turbo test --filter=backend
        env:
          NODE_ENV: test
          MONGODB_URI: mongodb://test:test@localhost:27017/test_db?authSource=admin
          REDIS_URL: redis://localhost:6379

      - name: Upload backend coverage
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: backend-coverage
          path: apps/backend/coverage/
          retention-days: 7

  test-frontend:
    name: Test Frontend
    runs-on: ubuntu-latest
    needs: [changes, setup]
    if: needs.changes.outputs.frontend == 'true'

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: ${{ env.BUN_VERSION }}

      - name: Restore dependencies cache
        uses: actions/cache@v4
        with:
          path: |
            node_modules
            apps/*/node_modules
            packages/*/node_modules
            ~/.bun/install/cache
          key: ${{ needs.setup.outputs.cache-key }}
          fail-on-cache-miss: true

      - name: Restore Turbo cache
        uses: actions/cache@v4
        with:
          path: .turbo
          key: turbo-${{ github.sha }}
          restore-keys: |
            turbo-

      - name: Run frontend tests
        run: bun run turbo test --filter=frontend
        env:
          NODE_ENV: test

      - name: Upload frontend coverage
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: frontend-coverage
          path: apps/frontend/coverage/
          retention-days: 7

  build:
    name: Build Applications
    runs-on: ubuntu-latest
    needs: [changes, setup, lint, typecheck]
    if: needs.changes.outputs.backend == 'true' || needs.changes.outputs.frontend == 'true'

    strategy:
      matrix:
        workspace: [backend, frontend]
        include:
          - workspace: backend
            condition: needs.changes.outputs.backend == 'true'
          - workspace: frontend
            condition: needs.changes.outputs.frontend == 'true'
      fail-fast: false

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: ${{ env.BUN_VERSION }}

      - name: Restore dependencies cache
        uses: actions/cache@v4
        with:
          path: |
            node_modules
            apps/*/node_modules
            packages/*/node_modules
            ~/.bun/install/cache
          key: ${{ needs.setup.outputs.cache-key }}
          fail-on-cache-miss: true

      - name: Restore Turbo cache
        uses: actions/cache@v4
        with:
          path: .turbo
          key: turbo-${{ github.sha }}
          restore-keys: |
            turbo-

      - name: Build ${{ matrix.workspace }}
        if: matrix.condition == 'true'
        run: bun run turbo build --filter=${{ matrix.workspace }}

      - name: Upload build artifacts - ${{ matrix.workspace }}
        if: matrix.condition == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.workspace }}-build
          path: apps/${{ matrix.workspace }}/dist/
          retention-days: 7

  security:
    name: Security Audit
    runs-on: ubuntu-latest
    needs: [changes, setup]
    if: needs.changes.outputs.backend == 'true' || needs.changes.outputs.frontend == 'true' || needs.changes.outputs.packages == 'true'

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: ${{ env.BUN_VERSION }}

      - name: Restore dependencies cache
        uses: actions/cache@v4
        with:
          path: |
            node_modules
            apps/*/node_modules
            packages/*/node_modules
            ~/.bun/install/cache
          key: ${{ needs.setup.outputs.cache-key }}
          fail-on-cache-miss: true

      - name: Run security audit
        run: bun audit

      - name: Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          scan-ref: '.'
          format: 'sarif'
          output: 'trivy-results.sarif'

      - name: Upload Trivy scan results
        if: always()
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: 'trivy-results.sarif'

  coverage:
    name: Coverage Report
    runs-on: ubuntu-latest
    needs: [test-backend, test-frontend]
    if: always() && (needs.test-backend.result == 'success' || needs.test-frontend.result == 'success')

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Download backend coverage
        if: needs.test-backend.result == 'success'
        uses: actions/download-artifact@v4
        with:
          name: backend-coverage
          path: backend-coverage/

      - name: Download frontend coverage
        if: needs.test-frontend.result == 'success'
        uses: actions/download-artifact@v4
        with:
          name: frontend-coverage
          path: frontend-coverage/

      - name: Upload to Codecov
        uses: codecov/codecov-action@v4
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
          files: |
            ./backend-coverage/lcov.info
            ./frontend-coverage/lcov.info
          flags: unittests
          name: codecov-umbrella
          fail_ci_if_error: false

  quality-gate:
    name: Quality Gate
    runs-on: ubuntu-latest
    needs: [lint, typecheck, test-backend, test-frontend, build, security]
    if: always()

    steps:
      - name: Check quality gate
        run: |
          echo "Quality Gate Results:"
          echo "Lint: ${{ needs.lint.result }}"
          echo "TypeCheck: ${{ needs.typecheck.result }}"
          echo "Backend Tests: ${{ needs.test-backend.result }}"
          echo "Frontend Tests: ${{ needs.test-frontend.result }}"
          echo "Build: ${{ needs.build.result }}"
          echo "Security: ${{ needs.security.result }}"

          # Check if any critical jobs failed
          if [[ "${{ needs.lint.result }}" == "failure" ]] || \
             [[ "${{ needs.typecheck.result }}" == "failure" ]] || \
             [[ "${{ needs.test-backend.result }}" == "failure" ]] || \
             [[ "${{ needs.test-frontend.result }}" == "failure" ]] || \
             [[ "${{ needs.build.result }}" == "failure" ]]; then
            echo "âŒ Quality gate failed!"
            exit 1
          else
            echo "âœ… Quality gate passed!"
          fi

      - name: Comment PR
        if: github.event_name == 'pull_request' && always()
        uses: actions/github-script@v7
        with:
          script: |
            const results = {
              lint: '${{ needs.lint.result }}',
              typecheck: '${{ needs.typecheck.result }}',
              'test-backend': '${{ needs.test-backend.result }}',
              'test-frontend': '${{ needs.test-frontend.result }}',
              build: '${{ needs.build.result }}',
              security: '${{ needs.security.result }}'
            };

            const statusEmoji = {
              success: 'âœ…',
              failure: 'âŒ',
              cancelled: 'â¹ï¸',
              skipped: 'â­ï¸'
            };

            let comment = '## ğŸš€ CI Pipeline Results\n\n';

            for (const [job, result] of Object.entries(results)) {
              const emoji = statusEmoji[result] || 'â“';
              comment += `${emoji} **${job}**: ${result}\n`;
            }

            const passed = Object.values(results).every(r => r === 'success' || r === 'skipped');
            comment += `\n**Overall Status**: ${passed ? 'âœ… PASSED' : 'âŒ FAILED'}`;

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });